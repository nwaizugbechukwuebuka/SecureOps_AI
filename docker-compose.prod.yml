# Production Docker Compose Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  app:
    environment:
      - DEBUG=false
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
    restart: unless-stopped
    
  backend:
    environment:
      - DEBUG=false
      - ENVIRONMENT=production 
      - LOG_LEVEL=INFO
    restart: unless-stopped
    
  db:
    environment:
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256 --auth-local=scram-sha-256
    volumes:
      - pgdata:/var/lib/postgresql/data:Z  # SELinux label
    restart: unless-stopped
    
  redis:
    command: >
      redis-server 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru 
      --save 60 1000
      --requirepass ${REDIS_PASSWORD:-secureops2025}
      --user default on >${REDIS_PASSWORD:-secureops2025} ~* &* +@all
    restart: unless-stopped
    
  celery-worker:
    environment:
      - DEBUG=false
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - REDIS_URL=redis://:${REDIS_PASSWORD:-secureops2025}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-secureops2025}@redis:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-secureops2025}@redis:6379/2
    restart: unless-stopped
    
  celery-beat:
    environment:
      - DEBUG=false
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - REDIS_URL=redis://:${REDIS_PASSWORD:-secureops2025}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-secureops2025}@redis:6379/1  
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-secureops2025}@redis:6379/2
    restart: unless-stopped
    
  nginx:
    restart: unless-stopped
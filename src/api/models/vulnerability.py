"""Vulnerability models for security tracking."""

from datetime import datetime
from typing import Optional

from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    String,
    Integer,
    Text,
    JSON,
    ForeignKey,
    Float,
)
from sqlalchemy.orm import relationship

from .base import Base, IDMixin, TimestampMixin


class Vulnerability(Base, IDMixin, TimestampMixin):
    """Vulnerability tracking model."""

    __tablename__ = "vulnerabilities"

    # Basic Information
    title = Column(String(255), nullable=False, index=True)
    description = Column(Text, nullable=True)
    severity = Column(
        String(20), nullable=False, index=True
    )  # low, medium, high, critical
    cve_id = Column(String(20), nullable=True, index=True)  # CVE identifier

    # CVSS Scoring
    cvss_score = Column(Float, nullable=True)
    cvss_vector = Column(String(200), nullable=True)

    # Package/Component Information
    package_name = Column(String(255), nullable=True, index=True)
    package_version = Column(String(100), nullable=True)
    fixed_version = Column(String(100), nullable=True)

    # Classification
    vulnerability_type = Column(
        String(50), nullable=False
    )  # dependency, code, infrastructure
    category = Column(String(100), nullable=True)  # injection, xss, etc.

    # Status
    status = Column(
        String(20), default="open", nullable=False, index=True
    )  # open, triaged, fixed, accepted_risk
    remediation_effort = Column(String(20), nullable=True)  # low, medium, high

    # Discovery Information
    scanner_name = Column(String(100), nullable=True)
    scan_job_id = Column(Integer, ForeignKey("scan_jobs.id"), nullable=True)
    pipeline_run_id = Column(Integer, ForeignKey("pipeline_runs.id"), nullable=True)

    # File/Location Information
    file_path = Column(String(500), nullable=True)
    line_number = Column(Integer, nullable=True)
    code_snippet = Column(Text, nullable=True)

    # External References
    external_references = Column(JSON, nullable=True)  # URLs, advisories, etc.

    # Management
    assigned_to = Column(Integer, ForeignKey("users.id"), nullable=True)
    due_date = Column(DateTime, nullable=True)
    resolution_note = Column(Text, nullable=True)
    resolved_at = Column(DateTime, nullable=True)
    resolved_by = Column(Integer, ForeignKey("users.id"), nullable=True)

    def get_risk_level(self) -> str:
        """Calculate risk level based on CVSS score and other factors."""
        if self.cvss_score is None:
            return "unknown"

        if self.cvss_score >= 9.0:
            return "critical"
        elif self.cvss_score >= 7.0:
            return "high"
        elif self.cvss_score >= 4.0:
            return "medium"
        else:
            return "low"

    def is_exploitable(self) -> bool:
        """Check if vulnerability is likely exploitable."""
        # Simple heuristic - can be enhanced
        if self.cvss_score and self.cvss_score >= 7.0:
            return True
        return False

    def to_dict(self) -> dict:
        return {
            "id": self.id,
            "title": self.title,
            "description": self.description,
            "severity": self.severity,
            "cve_id": self.cve_id,
            "cvss_score": self.cvss_score,
            "cvss_vector": self.cvss_vector,
            "package_name": self.package_name,
            "package_version": self.package_version,
            "fixed_version": self.fixed_version,
            "vulnerability_type": self.vulnerability_type,
            "category": self.category,
            "status": self.status,
            "remediation_effort": self.remediation_effort,
            "scanner_name": self.scanner_name,
            "file_path": self.file_path,
            "line_number": self.line_number,
            "risk_level": self.get_risk_level(),
            "is_exploitable": self.is_exploitable(),
            "assigned_to": self.assigned_to,
            "due_date": self.due_date.isoformat() if self.due_date else None,
            "resolved_at": self.resolved_at.isoformat() if self.resolved_at else None,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }

    def __repr__(self) -> str:
        return f"<Vulnerability(id={self.id}, title='{self.title}', severity='{self.severity}')>"
